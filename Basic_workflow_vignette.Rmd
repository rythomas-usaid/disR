---
title: "Basic workflow: Calculating Indicator Totals"
author: "Ryan Thomas"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic workflow: Calculating Indicator Totals}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette demonstrates how to load and access indicator data using the `disR` package. 

# Choose data set

First we will load data contained in the package. There are two key data sets: `magnus` and `extract`. See the documentation for the data sets in [link]. In short, the `magnus` data set is a duplication of the tables we store on Google Drive, which have been reformatted from the data that we can extract from the DIS. The DIS data extract contains additional information, such as country disaggregates, which allows more flexible reporting on specific slices of the data. However, the format is less user friendly.

## Using `magnus` data
```{r warning=F}
library(disR)
library(tidyverse)
load("data/magnus.Rdata")
```

With this data set loaded, we can easily calculate indicator totals for common indicators, such as those in the progress snapshot. The following code shows how to sum the number of people who received USG-supported degree-granting non-nutritional-related food security training (`EG.3.2-2`) between 2011-2022.

### Summarise EG.3.2-2 totals by year
First select the indicator(s) and disaggregates that you want to sum.
```{r echo=F, results='asis'}
ind_code <- "EG.3.2-2"
ind_key = "Sex"
indicators %>%  #Select all the indicators you want
      filter(ic_1819==ind_code &
               if_any(everything(), ~str_detect(., ind_key))) %>%
  knitr::kable()
```

Note that this data set does not contain much information about the indicators--only the name and disaggregates. We also need to join the values to these indicators to access the values. This is done using the `indicators$id` column in this table and the `values$id_ind` column in the values table.

```{r}
# replicate the lines from above
indicators %>%  #Select all the indicators you want
  filter(ic_1819==ind_code &
           if_any(everything(), ~str_detect(., ind_key))) %>% 
  
  # join only the "actual" (not "target") values
  left_join(x = ., y = filter(values, type=="Actual")
            , by = join_by(id == id_ind)
            , suffix = c("_ind", "_val")
            , keep = FALSE)  %>% 
  
  # group by the variables you want in the output
  group_by(Sex=d2, year) %>%
  
  # use the sum_ function, a wrapper that preserves NA vectors
  summarise(value = sum_(value)) %>% 
  
  pivot_wider(names_from = c("year")
              , values_from = "value"
              , values_fn = ~ sum_(.)) %>%
  knitr::kable()
```

## Using `extract` data set
Sometimes we need to slice the data in ways that are not as easy to identify based on the disaggregates in the `magnus` data set. 

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)

# You can enable figure captions by `fig_caption: yes` in YAML:
# 
#     output:
#       rmarkdown::html_vignette:
#         fig_caption: yes
# 
# Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.
```


## More Examples

```{r, echo=FALSE, results='asis'}
# You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.
knitr::kable(head(mtcars, 10))
```
