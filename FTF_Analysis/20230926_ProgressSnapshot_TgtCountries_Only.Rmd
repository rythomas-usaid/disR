---
title: "for Chris smallholder sales"
author: "Ryan Thomas"
date: "2023-09-26"
output: html_document
---

In FTF target countries, the value of sales for smallholder producers receiving USG assistance increased by more than 68 percent from FY 2020, totaling over $1.34 billion in FY 2021.

The number of individuals in the agri-food system applying improved management practices or technologies with USG assistance also increased by more than 50 percent in FTF target countries compared to FY 2020, with over 3.8 million individuals applying improved practices or technologies in FTF target countries FY 2021.

```{r}
options(scipen=999)
library(disR) # load data and custom functions
library(tidyverse)
library(googlesheets4)
```


```{r}
load("../../downloads/basic.Rdata")

values <- values[values$year %in% paste0("FY", 2019:2021),]
target_countries <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/18TGSvU1pE3Z8N5weY6wgsnDm1AiO3EvdWQtiYTUytXc/edit#gid=0", skip=1) %>%
  select(OU, tgt_2022 = `2022`, tgt_prev = `2021`)
```


```{r}
join_tables <- function(x) {
  x %>%
    left_join(x = ., y = filter(values, type=="Actual")
            , by = join_by(id == id_ind)
            , suffix = c("_ind", "_val") # label variables 
            , keep = FALSE)  %>% #distinct(year)
  left_join(ims , join_by(id_im == id)) %>%
  left_join(target_countries, join_by(ou == OU))
}

sum_tgt_prev <- function(x) {
  x %>%
  filter(tgt_prev == "Target") %>%
      group_by(ic_1819, year) %>%
      summarise(tgt_prev_value = sum(value, na.rm=T)) %>%
      pivot_wider(names_from = c("year")
                  , values_from = "tgt_prev_value"
                  , values_fn = ~ if(all(is.na(.))) NA_real_ else sum(., na.rm=T)) %>%
    mutate(Label = "tgt_prev_value", .before=everything()) 
}

sum_tgt_2022 <- function(x) {
  x %>%
  filter(tgt_2022 == "Target") %>%
      group_by(ic_1819, year) %>%
      summarise(tgt_2022_value = sum(value, na.rm=T)) %>%
      pivot_wider(names_from = c("year")
                  , values_from = "tgt_2022_value"
                  , values_fn = ~ if(all(is.na(.))) NA_real_ else sum(., na.rm=T)) %>%
    mutate(Label = "tgt_2022_value", .before=everything())
}
```


```{r}

bind_rows({ # Small holder sales
  indicators %>%  
  #Select all the indicators you want
  filter(str_detect(ic_1819, "EG.3.2-26/EG.3.2-x19") &
           if_any(everything(), ~ str_detect(., "Sex")) &
           if_any(d4, ~str_detect(., "Value of Sales")) &
           d2 == "Producer - Smallholder" ) %>% 
    
    join_tables() %>% 
    sum_tgt_2022()
 
},{
  indicators %>%  
  #Select all the indicators you want
  filter(str_detect(ic_1819, "EG.3.2-26/EG.3.2-x19") &
           if_any(everything(), ~str_detect(., "Sex")) &
           if_any(d4, ~str_detect(., "Value of Sales")) &
           d2 == "Producer - Smallholder" ) %>% 
    join_tables() %>% 
    sum_tgt_prev()
  
} , { # Financing "EG.3.2-27/EG.3.2-x6"
  indicators %>%
  #Select all the indicators you want
  filter((str_detect(ic_1819, "EG.3.2-27/EG.3.2-x6") &
           if_any(everything(), ~str_detect(., "Sex")) &
            if_any(everything(), ~ str_detect(., "Value"))) |
           ic == "EG.3.2-x6" & str_detect(d1, "Sex"))  %>% 
    join_tables() %>% 
    sum_tgt_prev()
}, { 
  indicators %>%
  #Select all the indicators you want
  filter((str_detect(ic_1819, "EG.3.2-27/EG.3.2-x6") &
           if_any(everything(), ~str_detect(., "Sex")) &
            if_any(everything(), ~ str_detect(., "Value"))) |
           ic == "EG.3.2-x6" & str_detect(d1, "Sex"))  %>% 
    join_tables() %>% 
    sum_tgt_2022()
  
}, { # Number of individuals
   indicators %>%  #Select all the indicators you want
      filter(str_detect(ic_1819,  "EG.3.2-24/EG.3.2-x17") &
               if_any(everything(), ~str_detect(., "Sex")) ) %>%
    join_tables() %>% 
    sum_tgt_2022()
} , { # Number of individuals
   indicators %>%  #Select all the indicators you want
      filter(str_detect(ic_1819,  "EG.3.2-24/EG.3.2-x17") &
               if_any(everything(), ~str_detect(., "Sex")) ) %>%
    join_tables() %>% 
    sum_tgt_prev()

  },{ # Hectares "EG.3.2-25/EG.3.2-x18"
    
  indicators %>%  #Select all the indicators you want
      filter(str_detect(ic_1819, "EG.3.2-25/EG.3.2-x18") &
               if_any(everything(), ~str_detect(., "Sex")) &
               if_any(d1, ~str_detect(., c("Crop Land|Cultivated Pasture|Cultivated Land|Aquaculture")))) %>%
      join_tables() %>%
      sum_tgt_prev()
    }, {
      indicators %>%  #Select all the indicators you want
      filter(str_detect(ic_1819, "EG.3.2-25/EG.3.2-x18") &
               if_any(everything(), ~str_detect(., "Sex")) &
               if_any(d1, ~str_detect(., c("Crop Land|Cultivated Pasture|Cultivated Land|Aquaculture")))) %>%
      join_tables() %>%
      sum_tgt_2022()
    }) %>% 
  write.csv("../../../output/forChris_fy19-fy21 target country progress.csv")
```
